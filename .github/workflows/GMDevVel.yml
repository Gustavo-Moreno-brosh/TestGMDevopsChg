name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'
  ServiceNowDevOpsChange:
    # jobs that must complete successfully before this job will run
    needs: build
    # type of machine to run the job on lol
    runs-on: ubuntu-latest
    name: 'ServiceNow DevOps Change'
    steps:
      - name: ServiceNow Change
        uses: ServiceNow/servicenow-devops-change@v4.1.0
        with:
          # Devops Integration Token
          devops-integration-user-name: admin #devops.integration.user
          devops-integration-user-password: Wn@9eANy$0Sn #Gama2024*
          # ServiceNow Instance URL
          instance-url: https://dev230972.service-now.com/
          # Orchestration Tool Id
          tool-id: 6c79a2f383e9521040b9f120feaad325
          # GitHub Context
          context-github: ${{ toJSON(github) }}
          # Display Name of the Job
          job-name: 'ServiceNow DevOps Change'
          change-request: '{"setCloseCode":"true","autoCloseChange":true,"attributes":{"chg_model":{"name": "DevOps"},"short_description":"Automated Software Deployment","description":"Automated Software Deployment.","assignment_group":"a715cd759f2002002920bde8132e7018","implementation_plan":"Software update is tested and results can be found in Test Summaries Tab; When the change is approved the implementation happens automated by the CICD pipeline within the change planned start and end time window.","backout_plan":"When software fails in production, the previous software release will be re-deployed.","test_plan":"Testing if the software was successfully deployed"}}'
          interval: '100'
          timeout: '3600'
          changeCreationTimeOut: '3600'
          abortOnChangeCreationFailure: true
          abortOnChangeStepTimeout: true
      - name: Output of Change Creation
        run: echo "change-request-number = ${{ steps.create.outputs.change-request-number }}" >> $GITHUB_OUTPUT
      - name: print Change
        run: echo ${{ steps.create.outputs.change-request-number }}